<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ICE Connectivity Test</title>
  <style>
    body { font-family: monospace; background: #f0f0f0; padding: 20px; }
    pre { background: #fff; padding: 10px; border: 1px solid #ccc; height: 300px; overflow-y: scroll; }
  </style>
</head>
<body>
  <h2>ðŸ§ª ICE Test (Client Side)</h2>
  <pre id="log"></pre>

  <script>
    const logBox = document.getElementById("log");
    const log = (msg) => {
      console.log(msg);
      logBox.textContent += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    };

    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      iceCandidatePoolSize: 10
    });

    const dc = pc.createDataChannel("test");
    dc.onopen = () => {
      log("ðŸ“¡ DataChannel open (client)");
      dc.send("Hello from client!");
    };

    dc.onmessage = (e) => log("ðŸ’¬ Message from server: " + e.data);

    pc.onicecandidate = (e) => {
      if (e.candidate) {
        const cand = e.candidate.candidate;
        const type = (cand.match(/typ\s(\w+)/) || [])[1] || "unknown";
        log(`ðŸ“¨ ICE candidate (${type}): ${cand}`);
      } else {
        log("âœ… ICE gathering complete\n");
      }
    };

    pc.oniceconnectionstatechange = () => {
      const state = pc.iceConnectionState;
      log(`ðŸ“¡ ICE state changed: ${state}`);
      if (state === "connected" || state === "completed") {
        log("âœ… ICE connected!\n");
        setTimeout(getSelectedPair, 2000);  // thÃªm delay Ä‘á»ƒ Ä‘áº£m báº£o stats Ä‘áº§y Ä‘á»§
      } else if (state === "failed") {
        log("âŒ ICE failed");
      }
    };

    async function getSelectedPair() {
  const stats = await pc.getStats();
  let selectedPair = null;
  const localCandidates = {};
  const remoteCandidates = {};

  stats.forEach(report => {
    if (report.type === "local-candidate") localCandidates[report.id] = report;
    if (report.type === "remote-candidate") remoteCandidates[report.id] = report;
    if (report.type === "candidate-pair" && (report.selected || report.nominated || report.state === "succeeded")) {
      selectedPair = report;
    }
  });

  if (selectedPair) {
    const local = localCandidates[selectedPair.localCandidateId];
    const remote = remoteCandidates[selectedPair.remoteCandidateId];

    if (local && remote) {
      log(`âœ… Selected candidate pair:`);
      log(`â†’ local: ${local.candidateType} ${local.address}:${local.port}`);
      log(`â†’ remote: ${remote.candidateType} ${remote.address}:${remote.port}`);
    } else {
      log("âš ï¸ Selected pair found but candidate details missing.");
    }
  } else {
    log("âŒ No candidate-pair with 'selected' or 'succeeded' found.");
  }
}


    async function start() {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await new Promise(resolve => {
        if (pc.iceGatheringState === "complete") return resolve();
        pc.onicegatheringstatechange = () => {
          if (pc.iceGatheringState === "complete") resolve();
        };
      });

      const response = await fetch("/offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sdp: pc.localDescription.sdp })
      });

      const { sdp } = await response.json();
      await pc.setRemoteDescription({ type: "answer", sdp });
    }

    start();
  </script>
</body>
</html>
